#!/sbin/sh
#This file is part of Universal Systemless Installer
#
#    The Universal Systemless Installer scripts are free software: you can redistribute
#    it and/or modify it under the terms of the GNU General Public License as published
#    by the Free Software Foundation, either version 2 of the License, or
#    (at your option) any later version, w/Systemless Xposed installable zip exception.
#
#    These scripts are distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.

##########################################################################################
# Changelog
##########################################################################################
# v0.1h - changed unzip routine to be abi-specific, _xposed rename, chromeos removed
# v0.1g - changed imgsize detection, fixed ui_print, some minor bugs and typo's 
# v0.1f - changed abi to abilist detection since sdk21+ uses
# v0.1e - changed bootpartition detection
# v0.1d - fixed some bugs
# v0.1c - added support for custom xposed frameworks and xposed installers
# v0.1b - added auto installation of material-design-xposed-installer
# v0.1a - initial alpha non-public release

##########################################################################################
# Urls/Credits
##########################################################################################
# http://dl-xda.xposed.info/framework 		: rovo89 - xposed framework
# http://download.chainfire.eu/supersu 		: chainfire - systemless idea & tools
# http://topjohnwu.github.io/ 			: topjohnwu - systemless xposed idea
# https://github.com/dvdandroid/XposedInstaller : dvdandroid - xposed-installer
# http://forum.xda-developers.com/xposed/super-alpha-posted-permission-xposed-t3072979 -
# romracer / xposed-installer

##########################################################################################
# Variables
##########################################################################################
OUTFD="/proc/self/fd/$2"
ZIP="$3"
ZIPDIR="${3%/*}"
TMPDIR="/tmp/$RANDOM"
IMGDIR="/xposed"
IMGNAME="xposed.img"
APP="Universal Systemless Installer for Xposed Framework"
AUT="st0rm"
VER="0.1h"
LIC="GPL v2"

##########################################################################################
# Cleaning up
##########################################################################################
trap '
ui_print " "
rm -rf "$TMPDIR"
sync
unset LD_LIBRARY_PATH
mountpoint -q $IMGDIR && umount $IMGDIR
mountpoint -q /system && umount /system
#[ -f /tmp/recovery.log ] && cat /tmp/recovery.log|tail -c+$LOGSIZE > $ZIP.log
[ -f /tmp/recovery.log ] && cp /tmp/recovery.log $ZIP.log
exit
' 0 1 2 3 15

#LOGSIZE=`wc -c < /tmp/recovery.log`
[ -f $ZIP.log ] && rm -f $ZIP.log

##########################################################################################
# Functions
##########################################################################################
ui_print(){ printf "ui_print $*\nui_print \n">$OUTFD;}
ui_print_exit(){ ui_print $*;exit 1;}
grep_prop(){ grep "^$1=" $2|sed "s/^.*=//g";}
set_perm(){ chcon $1 $5 && chmod $2 $5 && chown $3:$4 $5;}

##########################################################################################
# Banner
##########################################################################################
ui_print " "
ui_print "******************************"
ui_print "Universal Systemless Installer"
ui_print "    for Xposed Framework"
ui_print "         ver: $VER"
ui_print " "
ui_print "     written by: $AUT"
ui_print "   Licensed under: $LIC"
ui_print "******************************"
ui_print " "

##########################################################################################
# Mounting
##########################################################################################
ui_print "- Mounting /system(ro), /data, /cache"
mountpoint -q /system || mount -o,ro /system \
 || ui_print_exit "! Failed, unable to mount /system"
mountpoint -q /data || mount /data || mountpoint -q /cache || mount /cache \
 || ui_print_exit "!Failed, unable to mount /data or /cache"

[ -d /system/lib64 ] \
  && LD_LIBRARY_PATH=/system/lib64 \
  || LD_LIBRARY_PATH=/system/lib
ui_print "- Setting library path: $LD_LIBRARY_PATH"

##########################################################################################
# Prerequisites
##########################################################################################

BUILD_PROP="/system/build.prop"
[ ! -f $BUILD_PROP ] \
  && ui_print_exit "! Failed: build.prop not found"

ABI=`grep_prop ro.product.cpu.abilist $BUILD_PROP|sed 's/,/\n/g'|head -1`

API=`grep_prop ro.build.version.sdk $BUILD_PROP`

#https://developer.android.com/ndk/guides/abis.html
#translation to rovo89 xposed releases
case $ABI in
 armeabi)		ARCH=arm;;
 armeabi-v7a)		ARCH=arm;;
 arm64-v8a)		ARCH=arm64;;
 x86)			ARCH=$ABI;;
 x86_64)		ARCH=$ABI;;
 mips)			ARCH=$ABI;;
 mips64)		ARCH=$ABI;;
 *)			ui_print_exit "! Failed: $ABI is not supported (yet)";;
esac

ui_print "- Cpu architecture: $ABI/$ARCH, sdk$API"

ui_print "- UnZipping into TMPDIR: $TMPDIR"
mkdir -p "$TMPDIR"
unzip -o $ZIP "$ABI/*" "common/*" -d "$TMPDIR"
[ $? -eq 0 ] || ui_print_exit "! Failed: Unable to extract zip file!(0)"

##########################################################################################
# Building Xposed Filesystem Image
##########################################################################################
ui_print " "
ui_print "*************"
ui_print "Image builder"
ui_print "*************"

[ ! -d $IMGDIR ] \
  && mkdir -p $IMGDIR

mountpoint -q $IMGDIR \
  && umount $IMGDIR

IMG=$TMPDIR/build.img

SEARCH="xposed-v*-sdk${API}-${ARCH}*.zip"
VERSION=`find $ZIPDIR -type f -iname "$SEARCH" -maxdepth 2|sed 's/^.*xposed-v//'|sort -n|tail -1`
XPOSEDZIP=`find $ZIPDIR -type f -iname "xposed-v$VERSION"`

[ -z $XPOSEDZIP ] \
 &&  ui_print_exit "! File not found: $SEARCH"

IMGSIZE=`unzip -l $XPOSEDZIP |tail -1|awk '{print int($1/1024/1024)+6}'`

[ -z $IMGSIZE ] || [ $IMGSIZE -le 6 ] \
 && ui_print_exit "! Failed: $XPOSEDZIP is corrupt"

printf "${IMGDIR}(/.*)? u:object_r:system_file:s0\n">"$TMPDIR/file_contexts_image"
ui_print "- Building new image: $IMG (${IMGSIZE}M)"
make_ext4fs -l "${IMGSIZE}M" -a $IMGDIR -S "$TMPDIR/file_contexts_image" $IMG
chcon u:object_r:system_data_file:s0 $IMG
chmod 600 $IMG

ui_print "- Mounting $IMG to $IMGDIR"
mount -t ext4 -o,rw,noatime $IMG $IMGDIR
[ $? -eq 0 ] \
  || ui_print_exit "! Failed: Unable to mount $IMGDIR"

rmdir "$IMGDIR/lost+found"

ui_print "- UnZipping 'xposed-v$VERSION' into $IMGDIR"

unzip -o $XPOSEDZIP -d $IMGDIR "system/*"
[ $? -eq 0 ] || ui_print_exit "! Failed: Unable to extract zip file!(1)"

mv -f $IMGDIR/system/* $IMGDIR && rmdir $IMGDIR/system

find $IMGDIR -type d|while read dir ;do chown 0:0 $dir ;chmod 0755 $dir ;done

find $IMGDIR -type f|while read file;do

  CHOWN=0:0
  CHMOD=644
  CHCON=u:object_r:system_file:s0

  original=/system/${file#$IMGDIR/}
  if [ -f $original ];then
    CHOWN=$(ls -n $original|awk '{print $3":"$4}')
    RWX=`ls -la $original |awk '{print $1}'`
    CHMOD="u=${RWX:1:3},g=${RWX:4:3},o=${RWX:7:3}"
    CHCON=$(ls -Z $original|awk '{print $2}')
  fi

  case $file in
    /xposed/bin/app_process*)
      mv -f $file ${file%_xposed};file=${file%_xposed}
      ui_print "- Applying systemless patch to: $file"
      sed -i 's#/system/lib64/libxposed_art.so#/xposed/lib64/libxposed_art.so#g' $file
      sed -i 's#/system/lib/libxposed_art.so#/xposed/lib/libxposed_art.so#g' $file
      sed -i 's#/system/framework/XposedBridge.jar#/xposed/framework/XposedBridge.jar#g' $file
      sed -i 's#/system/xposed.prop#/xposed/xposed.prop#g' $file
      ;;
    /xposed/xposed.prop)
      sed -i "/version/s/$/ (systemless $VER by $AUT)/" $file
      ;;
  esac

  chown $CHOWN $file
  chmod $CHMOD $file
  chcon $CHCON $file

done

umount $IMGDIR

mountpoint -q /data \
  && cp -f $IMG "/data/$IMGNAME" \
  || cp -f $IMG "/cache/$IMGNAME"

##########################################################################################
# Installing XposedInstaller
##########################################################################################
ui_print " "
ui_print "******************"
ui_print "Package installer"
ui_print "******************"

SEARCH="*xposed*installer*.apk"
APKFILE=`find $ZIPDIR -type f -iname "$SEARCH" -maxdepth 2|head -1`

if [ ! -f $APKFILE ]; then
 ui_print "! Skipping install: $APKFILE not found."
else
 APKNAME=`aapt dump badging "$APKFILE"|grep package|sed "s/^package: name='//;s/' .*$//"`
 ui_print "- Installing: '${APKFILE##*/}'"
 mountpoint -q /data \
  && APPDIR=/data/app/$APKNAME-1 \
  || APPDIR=/cache/app/$APKNAME-1

 [ -d $APPDIR ] || mkdir -p $APPDIR
 [ -f $APPDIR/base.apk ] || cp -f $APKFILE $APPDIR/base.apk
 set_perm u:object_r:apk_data_file:s0 755 1000 1000 $APPDIR
 set_perm u:object_r:apk_data_file:s0 644 1000 1000 $APPDIR/base.apk
fi

##########################################################################################
# Boot image patch
##########################################################################################
ui_print " "
ui_print "******************"
ui_print "Boot image patcher"
ui_print "******************"

SUKERNEL=$TMPDIR/$ABI/sukernel
[ -f $SUKERNEL ] && chmod +x $SUKERNEL || ui_print_exit "! SUKERNEL not found"

for p in `find /dev/block -type l|grep -iE 'kern-a|android_boot|kernel|boot|lnx'`;do
 BOOTPARTITION=`readlink $p`;[ -z $BOOTPARTITION ]||break;done
[ -z ${BOOTPARTITION} ] \
  && ui_print_exit "! Failed: Boot partition NOT found." \
  || ui_print "- Found boot partition: $BOOTPARTITION"

ui_print "- Reading boot partition..."
dd bs=4096 if=$BOOTPARTITION of="$TMPDIR/boot.img"
[ $? == 0 ] \
  && ui_print "> Success" \
  || ui_print_exit "! Failed"

#Exitcode: 0/error, 1/Android, 2/ChromeOS
$SUKERNEL --bootimg-type $TMPDIR/boot.img
case $? in
 1)	IMGTYPE="android";;
 2)	ui_print_exit "! Xposed on ChromeOS?, contact me";;
 *)	ui_print_exit "! Failed (type=$IMGTYPE) (exit:[$?])";;
esac

ui_print "- Boot image type: $IMGTYPE"

ui_print "- Patching ramdisk"
RAMDISKDIR=$TMPDIR/common/ramdisk
$SUKERNEL --bootimg-extract-ramdisk $TMPDIR/boot.img $TMPDIR/ramdisk.gz
$SUKERNEL --ungzip $TMPDIR/ramdisk.gz $TMPDIR/ramdisk

update="
init.rc
init.xposed.rc
sbin/mount_xposed.sh
xposed
"

for item in $update;do
  case $item in
    init.rc)
      $SUKERNEL --cpio-extract $TMPDIR/ramdisk $item $RAMDISKDIR/$item
      if [ $(grep -c "import /init.xposed.rc" $TMPDIR/$item) == 0 ]; then
        sed -i "\#import /init.environ.rc#iimport /init.xposed.rc" $RAMDISKDIR/$item
        $SUKERNEL --cpio-add $TMPDIR/ramdisk $TMPDIR/ramdisk 750 $item $RAMDISKDIR/$item
        ui_print "  > $item"
      else
        ui_print "  ! Skipping: $item (already patched)"
      fi
      ;;
    init.xposed.rc)
      $SUKERNEL --cpio-add $TMPDIR/ramdisk $TMPDIR/ramdisk 750 $item $RAMDISKDIR/$item
      ;;
    sbin/mount_xposed.sh)
      $SUKERNEL --cpio-add $TMPDIR/ramdisk $TMPDIR/ramdisk 700 $item $RAMDISKDIR/$item
      ;;
    xposed)
      $SUKERNEL --cpio-mkdir $TMPDIR/ramdisk $TMPDIR/ramdisk 755 $item
      ;;
  esac
done

ui_print "- Building new boot image"
$SUKERNEL --gzip $TMPDIR/ramdisk $TMPDIR/ramdisk.gz
$SUKERNEL --bootimg-replace-ramdisk $TMPDIR/boot.img $TMPDIR/ramdisk.gz $TMPDIR/patched_boot.img

ui_print "- Syncing data"
sync

ui_print "- Writing boot partition..."

dd bs=4096 if=$TMPDIR/patched_boot.img of=$BOOTPARTITION \
  && { ui_print "> Success";exit 0;}

dd bs=4096 if=$TMPDIR/boot.img of=$BOOTPARTITION \
  && ui_print_exit "!Failed, succesfully restored backup" \
  || ui_print_exit "!Failed, failed to restore backup"

##########################################################################################
exit 1

